<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Seoul Trip 2025-26</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Import Zen Maru Gothic (Rounded) & Noto Sans TC -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'cream-bg': '#FDFBF7',     // Creamy White Background
                        'snow-blue': '#E8F4F8',    // Very Light Blue for contrast
                        'festive-red': '#D65A5A',  // Muted Christmas Red
                        'festive-green': '#5D7A61',// Pine Green
                        'festive-gold': '#E6B450', // Muted Gold
                        'text-main': '#4A4A4A',    // Dark Warm Grey
                        'text-sub': '#888888',     // Light Grey
                        
                        'danger': '#E57373',
                        // Soft Pastel Category Colors
                        'cat-food': '#FFCCBC', 'cat-trans': '#B3E5FC', 'cat-shop': '#F8BBD0',
                        'cat-stay': '#E1BEE7', 'cat-spot': '#C8E6C9', 'cat-ticket': '#FFE0B2', 'cat-other': '#CFD8DC',
                        
                        'payer-public': '#B0BEC5', 'payer-andy': '#90CAF9', 'payer-lynn': '#F48FB1',
                    },
                    fontFamily: { 
                        rounded: ['"Zen Maru Gothic"', 'sans-serif'],
                        sans: ['"Noto Sans TC"', 'sans-serif']
                    },
                    boxShadow: {
                        'soft': '0 4px 20px rgba(0, 0, 0, 0.05)',
                        'card': '0 2px 8px rgba(0, 0, 0, 0.03), 0 1px 2px rgba(0, 0, 0, 0.04)',
                        'float': '0 10px 30px rgba(214, 90, 90, 0.2)',
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            background-color: #FDFBF7;
            background-image: radial-gradient(#E8F4F8 1.5px, transparent 1.5px);
            background-size: 24px 24px; /* Subtle dot pattern */
            color: #4A4A4A; 
            padding-bottom: 100px; 
            -webkit-tap-highlight-color: transparent; 
            font-family: "Noto Sans TC", sans-serif;
            min-height: 100vh;
        }

        h1, h2, h3, .font-title { font-family: "Zen Maru Gothic", sans-serif; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .custom-checkbox:checked + div { background-color: #5D7A61; border-color: #5D7A61; }
        .custom-checkbox:checked + div:after { content: '‚úî'; color: white; font-size: 12px; display: block; text-align: center; line-height: 16px; }
        
        /* Tab Active Style */
        .tab-active { 
            color: #D65A5A; 
            font-weight: 800;
            background-color: #FFF;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(214, 90, 90, 0.15);
            transform: translateY(-2px);
        }
        .tab-inactive { color: #888; font-weight: 500; }
        
        /* Card Style */
        .card-panel {
            background: #FFFFFF;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
            border: 1px solid rgba(0,0,0,0.02);
        }

        /* Calculator */
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .calc-btn { @apply text-xl font-bold rounded-2xl active:scale-95 transition-transform flex items-center justify-center select-none cursor-pointer shadow-sm h-14 border border-gray-100; font-family: "Zen Maru Gothic", sans-serif; }
        .calc-num { background: #FFF; color: #4A4A4A; }
        .calc-func { background: #F5F5F5; color: #5D7A61; }
        .calc-op { background: #E8F4F8; color: #D65A5A; }
        .calc-eq { background: #D65A5A; color: white; border: none; box-shadow: 0 4px 10px rgba(214, 90, 90, 0.3); }
        
        .select-wrapper { position: relative; }
        .select-wrapper::after { content: '‚ñº'; position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #888; font-size: 0.7rem; pointer-events: none; }
        .drag-handle { cursor: grab; touch-action: none; }
        .dragging { opacity: 0.5; background: #FFF8E1; transform: scale(0.98); border: 2px dashed #E6B450; }
        .plan-detail { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; }
        .plan-detail.expanded { max-height: 600px; transition: max-height 0.4s ease-in; }
        .map-wrapper { overflow: auto; touch-action: none; width: 100%; height: 100%; position: relative; }
        .modal-overlay { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(4px); }
        
        /* Timeline Line */
        .timeline-container { position: relative; }
        .timeline-line { 
            position: absolute; 
            left: 56px; 
            top: 20px; 
            bottom: 20px; 
            width: 2px; 
            background: #E6EBE6; 
            z-index: 0; 
        }

        /* Holiday Decoration */
        .holiday-icon { display: inline-block; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
    </style>
</head>
<body>

    <!-- Config Area -->
    <script>
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwxuIgrKhVQCso8THiA3fLyklX18P_6xMw7is-aVsXzZNQcbJBdLwWZQa7ziZf9Rx8LZw/exec'; 
    </script>

    <header class="fixed top-0 left-0 right-0 bg-white/90 backdrop-blur-sm z-40 h-16 flex items-center justify-center border-b border-gray-100 shadow-sm">
        <h1 class="text-xl font-title font-black tracking-widest text-festive-red flex items-center gap-2">
            <span class="text-2xl holiday-icon">üéÑ</span> SEOUL <span class="text-festive-green">2026</span> <span class="text-festive-gold text-lg">‚ú®</span>
        </h1>
        <div id="syncStatus" class="absolute right-4 text-xs text-gray-300"><i class="fa-solid fa-cloud"></i></div>
    </header>

    <main id="app" class="pt-20 px-4 max-w-md mx-auto min-h-screen relative z-10 pb-24">
        <!-- Content injected by JS -->
    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-lg border-t border-gray-100 h-20 flex justify-around items-center z-50 pb-safe shadow-[0_-5px_20px_rgba(0,0,0,0.03)]">
        <button onclick="router('plan')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-festive-green transition-all transform active:scale-95" data-target="plan"><i class="fa-solid fa-calendar-star text-xl mb-1"></i><span class="text-[10px] font-bold">Ë°åÁ®ã</span></button>
        <button onclick="router('map')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-festive-green transition-all transform active:scale-95" data-target="map"><i class="fa-solid fa-map-location-dot text-xl mb-1"></i><span class="text-[10px] font-bold">Âú∞Âúñ</span></button>
        <button onclick="router('wallet')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-festive-red transition-all transform active:scale-95" data-target="wallet">
            <div class="bg-festive-red text-white w-12 h-12 rounded-2xl flex items-center justify-center shadow-float mb-1 rotate-3"><i class="fa-solid fa-wallet text-lg"></i></div>
        </button>
        <button onclick="router('lists')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-festive-green transition-all transform active:scale-95" data-target="lists"><i class="fa-solid fa-clipboard-list text-xl mb-1"></i><span class="text-[10px] font-bold">Ê∏ÖÂñÆ</span></button>
        <button onclick="router('info')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-festive-green transition-all transform active:scale-95" data-target="info"><i class="fa-solid fa-circle-info text-xl mb-1"></i><span class="text-[10px] font-bold">Ë≥áË®ä</span></button>
    </nav>

    <!-- Calculator Modal -->
    <div id="calcModal" class="fixed inset-0 bg-black/20 z-[60] hidden flex flex-col justify-end fade-in backdrop-blur-sm">
        <div class="bg-white rounded-t-[2rem] p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-6"><span class="text-gray-500 font-bold ml-2 font-title">ÈáëÈ°çË®àÁÆó</span><button onclick="closeCalc()" class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-gray-400 hover:bg-gray-100 transition"><i class="fa-solid fa-xmark text-lg"></i></button></div>
            <div class="bg-cream-bg p-4 rounded-3xl mb-6 text-right text-4xl font-mono text-text-main h-20 flex items-center justify-end overflow-hidden border border-gray-100" id="calcDisplay">0</div>
            <div class="calc-grid mb-safe">
                <div class="calc-btn calc-func" onclick="calcAppend('(')">(</div><div class="calc-btn calc-func" onclick="calcAppend(')')">)</div><div class="calc-btn calc-func" onclick="calcAppend('/100')">%</div><div class="calc-btn calc-func" onclick="calcClear()">AC</div>
                <div class="calc-btn calc-num" onclick="calcAppend('7')">7</div><div class="calc-btn calc-num" onclick="calcAppend('8')">8</div><div class="calc-btn calc-num" onclick="calcAppend('9')">9</div><div class="calc-btn calc-op" onclick="calcAppend('/')">√∑</div>
                <div class="calc-btn calc-num" onclick="calcAppend('4')">4</div><div class="calc-btn calc-num" onclick="calcAppend('5')">5</div><div class="calc-btn calc-num" onclick="calcAppend('6')">6</div><div class="calc-btn calc-op" onclick="calcAppend('*')">√ó</div>
                <div class="calc-btn calc-num" onclick="calcAppend('1')">1</div><div class="calc-btn calc-num" onclick="calcAppend('2')">2</div><div class="calc-btn calc-num" onclick="calcAppend('3')">3</div><div class="calc-btn calc-op" onclick="calcAppend('-')">-</div>
                <div class="calc-btn calc-num" onclick="calcAppend('0')">0</div><div class="calc-btn calc-num" onclick="calcAppend('.')">.</div><div class="calc-btn calc-eq" onclick="calcConfirm()">=</div><div class="calc-btn calc-op" onclick="calcAppend('+')">+</div>
            </div>
        </div>
    </div>

    <!-- Data Sync Modal -->
    <div id="syncModal" class="fixed inset-0 modal-overlay z-[70] hidden flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-3xl p-8 w-full max-w-sm shadow-2xl border border-gray-100">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-snow-blue rounded-full flex items-center justify-center mx-auto mb-3 text-2xl text-festive-green">üîÑ</div>
                <h3 class="text-xl font-bold text-text-main font-title">ÊóÖ‰º¥ÂêåÊ≠•</h3>
                <p class="text-sm text-gray-400 mt-2">Ëã•Èõ≤Á´Ø‰∏çÁ©©ÔºåË´ã‰ΩøÁî®‰ª£Á¢ºÂÇ≥Ëº∏</p>
            </div>
            <textarea id="syncDataInput" rows="4" class="w-full bg-cream-bg border border-gray-200 rounded-2xl p-4 text-xs font-mono text-gray-600 mb-6 break-all focus:border-festive-green outline-none" placeholder="Ë≤º‰∏ä‰ª£Á¢º..."></textarea>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="exportData()" class="bg-gray-100 text-gray-600 py-3 rounded-2xl font-bold hover:bg-gray-200 transition">ÂåØÂá∫Ë§áË£Ω</button>
                <button onclick="importData()" class="bg-festive-green text-white py-3 rounded-2xl font-bold hover:opacity-90 shadow-lg transition">ÂåØÂÖ•Ë¶ÜËìã</button>
            </div>
            <button onclick="document.getElementById('syncModal').classList.add('hidden')" class="w-full mt-6 text-gray-400 text-sm hover:text-gray-600">Êö´ÊôÇ‰∏çÈúÄË¶Å</button>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        const config = { currencyRate: 0.024, currencySymbol: '‚Ç©', homeCurrency: 'NT$' };

        const staticData = {
            flights: { outbound: { date: '12/31', code: 'BR0170', time: '07:05 - 10:30' }, inbound:  { date: '01/03', code: 'BR0159', time: '19:45 - 21:40' } },
            itinerary: [
                {
                    day: '12/31 (‰∏â)', title: 'Ë∑®Âπ¥ & ÂçóÂ±±Â°î', shortTitle: 'D1 12/31', fullDate: '2025/12/31',
                    events: [
                        { id: 'e1', start: '04:15', end: '05:00', title: 'Ê∏ÖÂ§ßÊê≠Êó•Ë±™ÂÆ¢ÈÅã 1250', type: 'transport', transport: '04:00ÁôºËªä', note: 'Á¥Ñ1Â∞èÊôÇÂà∞‰∫åËà™' },
                        { id: 'e2', start: '07:05', end: '10:30', title: 'Èï∑Ê¶Æ BR0170 Ëµ∑È£õ', type: 'transport', transport: '‰∫åËà™Âªà', note: 'Ê©ü‰∏äË£úÁú†' },
                        { id: 'e3', start: '12:30', end: '13:30', title: 'ÂçàÈ§ê: BHCÁÇ∏Èõû', type: 'food', transport: 'Êù±Â§ßÈñÄÊ≠∑Âè≤ÂÖ¨Âúí8ËôüÂá∫Âè£', note: 'ÂøÖÈªûËµ∑Âè∏Âè£Âë≥' },
                        { id: 'e4', start: '14:00', end: '17:30', title: 'ÂçóÂ±±Â°î (È¶ñÁàæÂ°î)', type: 'activity', transport: 'ÊòéÊ¥û4ËôüÂá∫Âè£‚ÜíÂçóÂ±±Á∫úËªä', ticket: 'KlookÈ†òÁ•®', note: 'ÊÑõÊÉÖÈéñÁâÜÊãçÁÖß„ÄÅT4ËßÄÊôØÂè∞' },
                        { id: 'e5', start: '18:00', end: '18:30', title: 'ÊòéÊ¥ûÈÄõË°ó & ÊèõÈå¢', type: 'shopping', transport: 'ÂçóÂ±±Á∫úËªä‰∏ãÂ±±', note: 'Kakao Friends„ÄÅMoney BoxÊèõÈå¢' },
                        { id: 'e6', start: '18:00', end: '19:00', title: 'ÊôöÈ§ê: ËçíË¨¨ÁöÑÁîüËÇâ', type: 'food', transport: 'ÊòéÊ¥û6ËôüÂá∫Âè£', note: 'ÁÉ§ËÇâÂêÉÂà∞È£Ω' },
                        { id: 'e7', start: '20:00', end: '21:30', title: 'ÊòéÊ¥û‰∫ÇÊâìÁßÄ', type: 'activity', ticket: 'È†êÁ¥ÑÁ¢∫Ë™ç‰ø°', note: 'Á≤æÂΩ©ÊâìÊìäÊ®ÇË°®Êºî' },
                        { id: 'e8', start: '22:00', end: '23:00', title: 'ÂõûÈ£ØÂ∫ó‰ºëÊÅØ', type: 'stay', transport: 'Êù±Â§ßÈñÄ', note: 'ÂÖÖÈõª„ÄÅÊîæÊà∞Âà©ÂìÅ' },
                        { id: 'e9', start: '23:30', end: '00:00', title: 'DDP Ë∑®Âπ¥ÁáàÂÖâÁßÄ', type: 'activity', transport: 'Êù±Â§ßÈñÄ1ËôüÂá∫Âè£', note: '‰∫∫Â§öÊ≥®ÊÑèÂÆâÂÖ®ÔºåÊñ∞Âπ¥Âø´Ê®ÇÔºÅ' }
                    ]
                },
                { day: '01/01 (Âõõ)', title: 'ÈüìÊúç & ÂåóÊùë', shortTitle: 'D2 1/1', fullDate: '2026/01/01', events: [ { id: 'e21', start: '08:30', end: '09:30', title: 'Êó©È§ê: Isaac', type: 'food', transport: 'Êù±Â§ßÈñÄ3ËôüÂá∫Âè£', note: 'ÊéíÈöäÂêçÂ∫ó' }, { id: 'e22', start: '10:30', end: '12:30', title: 'Ë•øËä±ÈüìÊúçÈ´îÈ©ó', type: 'activity', transport: 'ÊôØÁ¶èÂÆÆ4ËôüÂá∫Âè£', ticket: 'KlookÂ∑≤Ë®Ç', note: 'ÊúâÂè∞ÁÅ£Â∫óÂì°' }, { id: 'e23', start: '12:30', end: '14:00', title: 'ÊôØÁ¶èÂÆÆ', type: 'activity', note: 'Á©øÈüìÊúçÂÖçÈñÄÁ•®', transport: 'Ê≠•Ë°åÂâçÂæÄ' }, { id: 'e24', start: '14:00', end: '16:00', title: 'ÂåóÊùëÈüìÂ±ãÊùë', type: 'activity', note: '‰øùÊåÅÂÆâÈùú', transport: 'ÂÆâÂúãÁ´ô' } ] },
                { day: '01/02 (‰∫î)', title: 'ÂçóÊÄ°Â≥∂‰∏ÄÊó•ÈÅä', shortTitle: 'D3 1/2', fullDate: '2026/01/02', events: [ { id: 'e31', start: '11:10', end: '11:20', title: '‰∏ÄÊó•ÈÅäÈõÜÂêà', type: 'important', transport: 'Êù±Â§ßÈñÄ10ËôüÂá∫Âè£', note: 'Ê∫ñÊôÇÂá∫Áôº' }, { id: 'e32', start: '13:00', end: '16:00', title: 'ÂçóÊÄ°Â≥∂', type: 'activity', note: 'ÂÜ¨Â≠£ÊàÄÊ≠åÊãçÊîùÂú∞' }, { id: 'e33', start: '17:00', end: '19:00', title: 'Êô®ÈùúÊ®πÊú®Âúí', type: 'activity', note: '‰∫îËâ≤ÊòüÂÖâÂ∫≠ÂúíÂ±ï' }, { id: 'e34', start: '22:00', end: '23:59', title: 'SPAREX Ê±óËí∏Âπï', type: 'activity', transport: 'Goodmorning City B3', ticket: '‚Ç©15000', note: 'ÊêìÊæ°È´îÈ©ó' } ] },
                { day: '01/03 (ÂÖ≠)', title: 'Âª£Ëóè & Ê®ÇÂ§©', shortTitle: 'D4 1/3', fullDate: '2026/01/03', events: [ { id: 'e41', start: '09:00', end: '11:00', title: 'Âª£ËóèÂ∏ÇÂ†¥', type: 'food', transport: 'ÈçæË∑Ø‰∫îË°ó8ËôüÂá∫Âè£', note: 'Ë≤∑Ê£âË¢´(128Ëôü)„ÄÅÂêÉÁ∂†Ë±ÜÁÖéÈ§Ö' }, { id: 'e42', start: '12:00', end: '14:00', title: 'Ê®ÇÂ§©ÂÖçÁ®ÖÂ∫ó', type: 'shopping', transport: '‰πôÊîØË∑ØÂÖ•Âè£7Ëôü', note: 'Ë≤∑‰øùÈ§äÂìÅ' }, { id: 'e43', start: '15:30', end: '16:00', title: 'ÂõûÈ£ØÂ∫óÊãøË°åÊùé', type: 'transport' }, { id: 'e44', start: '19:45', end: '21:40', title: 'ÂõûÁ®ãÁè≠Ê©ü BR0159', type: 'transport', transport: '‰ªÅÂ∑ùÊ©üÂ†¥', note: 'ÊèêÊó©2Â∞èÊôÇÂà∞' } ] }
            ],
            categories: ['È£≤È£ü', '‰∫§ÈÄö', 'Ë≥ºÁâ©ÈÄõË°ó', '‰ΩèÂÆø', 'ÊôØÈªû', 'ÈñÄÁ•®', 'ÂÖ∂‰ªñ'],
            catColors: { 'È£≤È£ü':'cat-food', '‰∫§ÈÄö':'cat-trans', 'Ë≥ºÁâ©ÈÄõË°ó':'cat-shop', '‰ΩèÂÆø':'cat-stay', 'ÊôØÈªû':'cat-spot', 'ÈñÄÁ•®':'cat-ticket', 'ÂÖ∂‰ªñ':'cat-other' },
            payers: ['ÂÖ¨Ë≤ª', 'Lynn', 'Andy'],
            payerColors: { 'ÂÖ¨Ë≤ª':'payer-public', 'Lynn':'payer-lynn', 'Andy':'payer-andy' },
            paymentMethods: ['ÁèæÈáë', '‰ø°Áî®Âç°', 'Ë°åÂãïÊîØ‰ªò'],
            splitOptions: ['Âπ≥ÂùáÂàÜÊî§', '‰∏çÂπ≥ÂùáÂàÜÊî§', 'Andy ÂÄã‰∫∫', 'Lynn ÂÄã‰∫∫']
        };

        const app = document.getElementById('app');
        
        function getInitialDay() {
            const todayStr = new Date().toISOString().slice(0, 10).replace(/-/g, '/');
            const idx = staticData.itinerary.findIndex(day => day.fullDate === todayStr);
            return idx !== -1 ? idx : 0; 
        }

        // Use new storage key v24 to force reset
        let savedItinerary = JSON.parse(localStorage.getItem('seoul_itinerary_v24'));
        if (!savedItinerary) { savedItinerary = staticData.itinerary; localStorage.setItem('seoul_itinerary_v24', JSON.stringify(savedItinerary)); }

        let state = {
            activeTab: 'plan',
            activeDay: getInitialDay(), 
            walletDay: getInitialDay(),
            expenseCurrency: 'KRW',
            itinerary: savedItinerary,
            expenses: JSON.parse(localStorage.getItem('seoul_expenses_v24')) || [], // New key
            checklist: JSON.parse(localStorage.getItem('seoul_checklist_v24')) || [], 
            memos: localStorage.getItem('seoul_memos_v24') || '',
            exchangeRate: parseFloat(localStorage.getItem('seoul_rate_v24')) || config.currencyRate,
            editingId: null,
            expandedEvents: [] 
        };

        if(state.checklist.length === 0) { 
             const groups = [
                { category: '3C Áî¢ÂìÅ', items: ['ÊâãÊ©ü', 'ÂÖÖÈõªÁ∑ö', 'ÂÖÖÈõªÂô®', 'Áõ∏Ê©ü', 'Ëê¨Áî®ËΩâÊé•È†≠', 'Ë°åÂãïÈõªÊ∫ê'] },
                { category: 'Ë°£Áâ©', items: ['‰∏äË°£', 'Ë§≤Â≠ê', 'Â§ñÂ•ó', 'ÈûãÂ≠ê', 'ÂÖßË°£Ë§≤', 'Â¢®Èè°', 'Â∏ΩÂ≠ê', 'ÂúçÂ∑æ', 'ÊâãÂ•ó'] },
                { category: 'Áõ•Ê¥óÂèäË°õÁîüÁî®ÂìÅ', items: ['Âç∏Â¶ùÂ∑æ', 'Ê¥óÈù¢‰π≥', 'ÁâôËÜè', 'ÁâôÂà∑', 'ÁâôÁ∑ö', 'ÊØõÂ∑æ', 'ÊøïÁ¥ôÂ∑æ', 'Èù¢Á¥ô'] },
                { category: 'ÂÄã‰∫∫Ëó•ÂìÅ', items: ['ÊöàËªäËó•', 'ÈÅéÊïèËó•', 'Ê∂àÊØíÁî®ÂìÅ', 'ÊÑüÂÜíËó•', 'OK ÁπÉ', 'ËöäËü≤Ê≠¢Áô¢Ëó•'] },
                { category: 'ÈáçË¶ÅÊñá‰ª∂', items: ['Ë∫´ÂàÜË≠â', 'Ë≠∑ÁÖß', 'ÂúãÈöõÈßïÁÖß', 'ÁôªÊ©üË≠âÊàñÊ©üÁ•®', '‰ΩèÂÆøÊàñ‰∫§ÈÄöÁ•®Âç∑Á≠âÈ†êË≥ºÁ•®Âà∏'] },
                { category: 'ÂÖ∂‰ªñÁî®ÂìÅ', items: ['Á©∫Ê∞¥Â£∫ÊàñÁí∞‰øùÊùØ', 'ÂÆ∂‰∏≠Èë∞Âåô', 'ÁúºÁΩ©', 'Â§ñÂπ£ÁèæÈáëÊàñ‰ø°Áî®Âç°', 'ËÄ≥Â°û', 'È†∏Êûï'] }
            ];
            groups.forEach(g => g.items.forEach(i => state.checklist.push({category:g.category, text:i, checked:false})));
        }

        function saveToLS() {
            localStorage.setItem('seoul_expenses_v24', JSON.stringify(state.expenses));
            localStorage.setItem('seoul_itinerary_v24', JSON.stringify(state.itinerary)); 
            localStorage.setItem('seoul_checklist_v24', JSON.stringify(state.checklist));
            localStorage.setItem('seoul_memos_v24', state.memos);
            localStorage.setItem('seoul_rate_v24', state.exchangeRate);
        }

        // --- SYNC ---
        function syncToCloud(action, item) {
            if(!GOOGLE_SCRIPT_URL) return; 
            const statusIcon = document.getElementById('syncStatus');
            statusIcon.innerHTML = '<i class="fa-solid fa-spinner fa-spin text-festive-red"></i>';
            const cleanItem = { ...item }; delete cleanItem.image;
            fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: action, item: cleanItem, id: cleanItem.id }) })
            .then(() => { setTimeout(() => statusIcon.innerHTML = '<i class="fa-solid fa-cloud text-festive-green"></i>', 1000); })
            .catch(err => { console.error(err); statusIcon.innerHTML = '<i class="fa-solid fa-circle-exclamation text-danger"></i>'; });
        }

        function exportData() {
            const data = { expenses: state.expenses, itinerary: state.itinerary, checklist: state.checklist, memos: state.memos };
            const json = JSON.stringify(data);
            const encoded = btoa(unescape(encodeURIComponent(json))); 
            document.getElementById('syncDataInput').value = encoded;
            document.getElementById('syncDataInput').select();
            document.execCommand('copy');
            alert('‰ª£Á¢ºÂ∑≤Ë§áË£ΩÔºÅË´ãÂÇ≥ÈÄÅÁµ¶ÊóÖ‰º¥„ÄÇ');
        }

        function importData() {
            const input = document.getElementById('syncDataInput').value.trim();
            if(!input) return alert('Ë´ãË≤º‰∏ä‰ª£Á¢º');
            try {
                const json = decodeURIComponent(escape(atob(input)));
                const data = JSON.parse(json);
                if(confirm('Ë≠¶ÂëäÔºöÈÄôÂ∞áÊúÉË¶ÜËìãÊÇ®ÁõÆÂâçÊâãÊ©ü‰∏äÁöÑÊâÄÊúâË≥áÊñôÔºåÁ¢∫ÂÆöÂåØÂÖ•ÂóéÔºü')) {
                    if(data.expenses) state.expenses = data.expenses;
                    if(data.itinerary) state.itinerary = data.itinerary;
                    if(data.checklist) state.checklist = data.checklist;
                    if(data.memos) state.memos = data.memos;
                    saveToLS();
                    alert('ÂåØÂÖ•ÊàêÂäüÔºÅÈ†ÅÈù¢Â∞áÈáçÊñ∞Êï¥ÁêÜ„ÄÇ');
                    location.reload();
                }
            } catch(e) {
                alert('‰ª£Á¢ºÈåØË™§ÔºåË´ãÁ¢∫Ë™çË§áË£ΩÂÆåÊï¥„ÄÇ');
            }
        }

        // --- RENDERERS ---
        function formatMoney(amount) { return parseFloat(amount).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }); }
        function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
        function safeCalculate(exp) { try { if (/[^0-9+\-*/.()%]/.test(exp)) return null; return Function('"use strict";return (' + exp + ')')(); } catch { return null; } }
        function compressImage(file, cb) { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = (e) => { const img = new Image(); img.src = e.target.result; img.onload = () => { const cvs = document.createElement('canvas'); const w = Math.min(img.width, 600); const h = img.height * (w/img.width); cvs.width=w; cvs.height=h; cvs.getContext('2d').drawImage(img,0,0,w,h); cb(cvs.toDataURL('image/jpeg', 0.6)); }}; }
        function calculateDuration(start, end) { if (!start || !end) return ''; const [h1, m1] = start.split(':').map(Number); const [h2, m2] = end.split(':').map(Number); let diff = (h2 * 60 + m2) - (h1 * 60 + m1); if (diff < 0) diff += 24 * 60; const h = Math.floor(diff / 60); const m = diff % 60; if (h > 0 && m > 0) return `${h}h${m}m`; if (h > 0) return `${h}h`; return `${m}m`; }

        // Plan Logic
        let dragSrcEl = null;
        function handleDragStart(e) { dragSrcEl = this.closest('.draggable-item'); e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/html', this.innerHTML); dragSrcEl.classList.add('dragging'); }
        function handleDragOver(e) { if (e.preventDefault) e.preventDefault(); return false; }
        function handleDragEnter(e) { this.closest('.draggable-item').classList.add('bg-white/50'); }
        function handleDragLeave(e) { this.closest('.draggable-item').classList.remove('bg-white/50'); }
        function handleDrop(e) { if (e.stopPropagation) e.stopPropagation(); const destItem = this.closest('.draggable-item'); if (dragSrcEl !== destItem) { const srcIdx = parseInt(dragSrcEl.dataset.index); const destIdx = parseInt(destItem.dataset.index); const dayEvents = state.itinerary[state.activeDay].events; const [movedItem] = dayEvents.splice(srcIdx, 1); dayEvents.splice(destIdx, 0, movedItem); saveToLS(); renderPlan(); } return false; }
        function handleDragEnd(e) { this.closest('.draggable-item').classList.remove('dragging'); document.querySelectorAll('.draggable-item').forEach(col => col.classList.remove('bg-white/50')); }
        function toggleEventExpand(evtId) { const idx = state.expandedEvents.indexOf(evtId); if(idx !== -1) state.expandedEvents.splice(idx, 1); else state.expandedEvents.push(evtId); renderPlan(); }
        function saveEventInline(evtId, field, value) { const dayEvents = state.itinerary[state.activeDay].events; const evt = dayEvents.find(e => e.id === evtId); if(evt) { evt[field] = value; saveToLS(); if(field === 'start' || field === 'end') renderPlan(); } }
        function addNewEvent() { const newEvt = { id: generateId(), start: '12:00', end: '13:00', title: 'Êñ∞Ë°åÁ®ã', type: 'activity', transport: '', ticket: '', note: '' }; state.itinerary[state.activeDay].events.push(newEvt); saveToLS(); renderPlan(); }
        function moveEvent(evtId, dir) { const dayEvents = state.itinerary[state.activeDay].events; const idx = dayEvents.findIndex(e => e.id === evtId); if(idx === -1) return; if (dir === -1 && idx > 0) { [dayEvents[idx], dayEvents[idx-1]] = [dayEvents[idx-1], dayEvents[idx]]; } else if (dir === 1 && idx < dayEvents.length - 1) { [dayEvents[idx], dayEvents[idx+1]] = [dayEvents[idx+1], dayEvents[idx]]; } saveToLS(); renderPlan(); }
        function deleteEvent(evtId) { if(!confirm('Âà™Èô§Ê≠§Ë°åÁ®ãÔºü')) return; const dayEvents = state.itinerary[state.activeDay].events; const idx = dayEvents.findIndex(e => e.id === evtId); if(idx !== -1) dayEvents.splice(idx, 1); saveToLS(); renderPlan(); }

        function renderPlan() {
            const day = state.itinerary[state.activeDay];
            let html = `
                <div class="sticky top-14 bg-cream-bg/95 z-20 pb-2 pt-1 flex justify-between gap-2 overflow-x-auto no-scrollbar mb-4 backdrop-blur-sm">
                    ${state.itinerary.map((d, i) => `<button onclick="state.activeDay=${i};renderPlan()" class="flex-1 py-2.5 px-1 text-base font-title transition-all whitespace-nowrap ${i === state.activeDay ? 'tab-active' : 'tab-inactive'}">${d.shortTitle}</button>`).join('')}
                </div>
                <div class="fade-in pb-20 px-2 timeline-container">
                    <div class="timeline-line"></div>
                    <div class="flex items-end mb-6 ml-10">
                        <h2 class="text-2xl font-title font-bold text-text-main mr-3">${day.day.split(' ')[0]}</h2>
                        <span class="text-xs text-white bg-festive-red px-3 py-1 rounded-full shadow-sm font-bold tracking-wide">${day.title}</span>
                    </div>
                    <div class="space-y-6" id="planList">
            `;
            day.events.forEach((event, index) => {
                const isExpanded = state.expandedEvents.includes(event.id);
                const highlightClass = event.type === 'important' ? 'border-l-4 border-l-festive-gold bg-yellow-50' : 'card-panel';
                const duration = calculateDuration(event.start, event.end);
                html += `
                    <div class="flex gap-4 relative group z-10">
                        <div class="w-12 flex-shrink-0 text-right pt-4 font-mono text-xs font-bold text-text-sub leading-tight">
                            <div class="bg-cream-bg py-1">${event.start}</div>
                            <div class="h-8"></div>
                            <div class="bg-cream-bg py-1">${event.end}</div>
                        </div>

                        <div class="flex-1 draggable-item relative p-4 ${highlightClass} transition" data-index="${index}">
                            <div class="flex items-start gap-3 cursor-pointer" onclick="toggleEventExpand('${event.id}')">
                                <div class="flex-1">
                                    ${duration ? `<span class="text-[10px] text-text-main bg-snow-blue px-2 py-0.5 rounded-full mb-2 inline-block font-bold"><i class="fa-regular fa-clock mr-1 text-festive-green"></i>${duration}</span>` : ''}
                                    <input type="text" class="w-full font-bold text-text-main text-lg outline-none bg-transparent font-title" value="${event.title}" onclick="event.stopPropagation()" onchange="saveEventInline('${event.id}', 'title', this.value)">
                                    ${!isExpanded && event.note ? `<p class="text-xs text-text-sub mt-2 line-clamp-1 font-bold"><i class="fa-solid fa-pen-fancy mr-1 text-festive-red"></i>${event.note}</p>` : ''}
                                </div>
                                <div class="drag-handle text-gray-300 p-2" draggable="true" onclick="event.stopPropagation()"><i class="fa-solid fa-bars"></i></div>
                                <div class="text-gray-300 p-2 plan-arrow ${isExpanded?'expanded':''}"><i class="fa-solid fa-chevron-down"></i></div>
                            </div>
                            <div class="plan-detail ${isExpanded?'expanded':''}">
                                <div class="mt-4 space-y-3 border-t border-gray-100 pt-3">
                                    <div class="flex items-center gap-2 text-xs text-gray-400 bg-gray-50 p-2 rounded-xl"><span>‰øÆÊîπÊôÇÈñì:</span><input type="time" class="bg-white border rounded p-1 text-xs" value="${event.start}" onchange="saveEventInline('${event.id}', 'start', this.value)"><span>-</span><input type="time" class="bg-white border rounded p-1 text-xs" value="${event.end}" onchange="saveEventInline('${event.id}', 'end', this.value)"></div>
                                    <div class="bg-cat-trans/20 p-3 rounded-xl border border-cat-trans/30"><div class="text-[10px] font-bold text-blue-500 mb-1 uppercase tracking-wider"><i class="fa-solid fa-train-subway mr-1"></i>‰∫§ÈÄöÊñπÂºè</div><textarea rows="1" class="w-full bg-transparent text-sm outline-none resize-none text-text-main font-bold" placeholder="Ëº∏ÂÖ•‰∫§ÈÄöË≥áË®ä..." onchange="saveEventInline('${event.id}', 'transport', this.value)">${event.transport || ''}</textarea></div>
                                    <div class="bg-cat-ticket/20 p-3 rounded-xl border border-cat-ticket/30"><div class="text-[10px] font-bold text-orange-500 mb-1 uppercase tracking-wider"><i class="fa-solid fa-ticket mr-1"></i>ÈñÄÁ•®/ÁáüÊ•≠</div><textarea rows="1" class="w-full bg-transparent text-sm outline-none resize-none text-text-main font-bold" placeholder="Ëº∏ÂÖ•ÈñÄÁ•®Ë≥áË®ä..." onchange="saveEventInline('${event.id}', 'ticket', this.value)">${event.ticket || ''}</textarea></div>
                                    <div class="bg-cat-stay/20 p-3 rounded-xl border border-cat-stay/30"><div class="text-[10px] font-bold text-purple-500 mb-1 uppercase tracking-wider"><i class="fa-solid fa-note-sticky mr-1"></i>ÂÇôË®ª</div><textarea rows="2" class="w-full bg-transparent text-sm outline-none resize-none text-text-main font-bold" placeholder="Ëº∏ÂÖ•ÂÇôË®ª..." onchange="saveEventInline('${event.id}', 'note', this.value)">${event.note || ''}</textarea></div>
                                    <div class="flex justify-end gap-2 mt-2"><button onclick="moveEvent('${event.id}', -1)" class="text-xs bg-white px-3 py-1.5 rounded-lg hover:bg-gray-100 text-gray-500 border border-gray-200">‚¨Ü</button><button onclick="moveEvent('${event.id}', 1)" class="text-xs bg-white px-3 py-1.5 rounded-lg hover:bg-gray-100 text-gray-500 border border-gray-200">‚¨á</button><button onclick="deleteEvent('${event.id}')" class="text-xs bg-white px-3 py-1.5 rounded-lg hover:bg-red-50 text-danger border border-red-100">Âà™Èô§</button></div>
                                </div>
                            </div>
                        </div>
                    </div>`;
            });
            html += `<button onclick="addNewEvent()" class="w-full py-4 rounded-2xl border-2 border-dashed border-gray-300 text-gray-400 font-bold hover:bg-white transition flex items-center justify-center gap-2 mt-6"><i class="fa-solid fa-plus"></i> Êñ∞Â¢ûË°åÁ®ã</button>`;
            html += `</div></div>`;
            app.innerHTML = html;
            
            document.querySelectorAll('.drag-handle').forEach(h => h.addEventListener('dragstart', handleDragStart, false));
            document.querySelectorAll('.draggable-item').forEach(i => { i.addEventListener('dragenter', handleDragEnter); i.addEventListener('dragover', handleDragOver); i.addEventListener('dragleave', handleDragLeave); i.addEventListener('drop', handleDrop); i.addEventListener('dragend', handleDragEnd); });
        }

        // Wallet Renderer
        function renderWallet() {
            let summary = { andy: { paid: 0, cost: 0 }, lynn: { paid: 0, cost: 0 }, publicPaid: 0 };
            
            state.expenses.forEach(ex => {
                let rate = state.exchangeRate;
                let amtTWD = ex.currency === 'KRW' ? ex.amount * rate : ex.amount;
                
                if (ex.payer === 'Andy') summary.andy.paid += amtTWD;
                else if (ex.payer === 'Lynn') summary.lynn.paid += amtTWD;
                else if (ex.payer === 'ÂÖ¨Ë≤ª') summary.publicPaid += amtTWD;

                if (ex.split === 'Âπ≥ÂùáÂàÜÊî§') { summary.andy.cost += amtTWD / 2; summary.lynn.cost += amtTWD / 2; }
                else if (ex.split === 'Andy ÂÄã‰∫∫') { summary.andy.cost += amtTWD; }
                else if (ex.split === 'Lynn ÂÄã‰∫∫') { summary.lynn.cost += amtTWD; }
                else if (ex.split === '‰∏çÂπ≥ÂùáÂàÜÊî§' && ex.customSplit) {
                    let sA = ex.currency === 'KRW' ? ex.customSplit.andy * rate : ex.customSplit.andy;
                    let sL = ex.currency === 'KRW' ? ex.customSplit.lynn * rate : ex.customSplit.lynn;
                    summary.andy.cost += sA; summary.lynn.cost += sL;
                }
            });

            const toKRW = (twd) => twd / state.exchangeRate;
            const andyNetTWD = summary.andy.paid - summary.andy.cost;
            const andyNetKRW = toKRW(andyNetTWD);
            const settlementText = andyNetTWD > 0 
                ? `Lynn ÈúÄÁµ¶ Andy <span class="text-festive-red font-black">‚Ç©${formatMoney(andyNetKRW)}</span>`
                : `Andy ÈúÄÁµ¶ Lynn <span class="text-festive-red font-black">‚Ç©${formatMoney(Math.abs(andyNetKRW))}</span>`;

            const andyAdvanceTWD = Math.max(0, summary.andy.paid - summary.andy.cost);
            const lynnAdvanceTWD = Math.max(0, summary.lynn.paid - summary.lynn.cost);

            let html = `
                <div class="fade-in pb-24">
                    <div class="card-panel p-6 mb-6 text-center bg-white relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 text-6xl opacity-10 text-festive-red rotate-12">‚ùÑ</div>
                         <div class="text-sm font-bold text-gray-500 mb-4 pb-4 border-b border-gray-100">
                            ÁµêÁÆó (Settlement) <br><span class="text-lg mt-2 block font-title text-text-main">${settlementText}</span>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <h3 class="text-xs text-gray-400 font-bold uppercase mb-1 font-title">Andy</h3>
                                <div class="text-xs text-text-main font-bold">‰ª£Â¢ä ‚Ç©${formatMoney(toKRW(andyAdvanceTWD))}</div>
                                <div class="text-[10px] text-gray-400">NT$${formatMoney(andyAdvanceTWD)}</div>
                            </div>
                            <div class="border-l border-gray-100">
                                <h3 class="text-xs text-gray-400 font-bold uppercase mb-1 font-title">Lynn</h3>
                                <div class="text-xs text-text-main font-bold">‰ª£Â¢ä ‚Ç©${formatMoney(toKRW(lynnAdvanceTWD))}</div>
                                <div class="text-[10px] text-gray-400">NT$${formatMoney(lynnAdvanceTWD)}</div>
                            </div>
                        </div>
                    </div>

                    <div class="card-panel p-6 mb-6 relative bg-white">
                        <h3 class="text-sm font-black text-festive-green mb-4 flex justify-between items-center tracking-widest font-title">
                            <span>${state.editingId ? '‚úèÔ∏è Á∑®ËºØË®òÂ∏≥' : '‚ú® Êñ∞Â¢ûË®òÂ∏≥'}</span>
                            ${state.editingId ? `<button onclick="cancelEdit()" class="text-danger"><i class="fa-solid fa-xmark"></i></button>` : ''}
                        </h3>
                        
                        <div class="space-y-4">
                            <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                                ${state.itinerary.map((d, i) => `
                                    <label class="flex-shrink-0 cursor-pointer">
                                        <input type="radio" name="expenseDay" value="${i}" class="peer hidden" ${i === state.walletDay ? 'checked' : ''} onchange="state.walletDay=${i}">
                                        <span class="px-4 py-2 rounded-xl text-xs bg-gray-50 text-gray-400 peer-checked:bg-festive-green peer-checked:text-white transition shadow-sm font-bold border border-transparent peer-checked:border-festive-green peer-checked:shadow-md">${d.shortTitle}</span>
                                    </label>
                                `).join('')}
                            </div>

                            <div class="grid grid-cols-2 gap-3">
                                <div class="select-wrapper"><select id="itemPayer" class="w-full bg-snow-blue border-0 rounded-xl p-3 text-sm outline-none appearance-none font-bold text-text-main">
                                    <option value="ÂÖ¨Ë≤ª" selected>ÂÖ¨Ë≤ª</option>
                                    ${staticData.payers.map(p => p!=='ÂÖ¨Ë≤ª'?`<option>${p}</option>`:'').join('')}
                                </select></div>
                                <div class="select-wrapper"><select id="itemMethod" class="w-full bg-snow-blue border-0 rounded-xl p-3 text-sm outline-none appearance-none font-bold text-text-main">
                                    <option value="ÁèæÈáë" selected>ÁèæÈáë</option>
                                    ${staticData.paymentMethods.map(m => m!=='ÁèæÈáë'?`<option>${m}</option>`:'').join('')}
                                </select></div>
                            </div>

                            <div class="select-wrapper">
                                <select id="itemCurrency" class="w-full bg-snow-blue border-0 rounded-xl p-3 text-sm outline-none appearance-none font-black text-festive-red" onchange="setCurrency(this.value)">
                                    <option value="KRW" ${state.expenseCurrency === 'KRW' ? 'selected' : ''}>KRW ‚Ç© (ÈüìÂÖÉ)</option>
                                    <option value="TWD" ${state.expenseCurrency === 'TWD' ? 'selected' : ''}>TWD $ (Âè∞Âπ£)</option>
                                </select>
                            </div>

                            <div class="relative">
                                <div class="flex gap-2">
                                    <div class="relative w-full">
                                        <span id="currSymbol" class="absolute left-4 top-3 text-gray-400 text-sm font-bold">${state.expenseCurrency === 'KRW' ? '‚Ç©' : '$'}</span>
                                        <input type="number" id="itemAmount" oninput="autoCalcSplit('total'); updateApprox()" placeholder="ÈáëÈ°ç" inputmode="decimal" class="w-full bg-snow-blue border-0 rounded-xl p-3 pl-8 text-lg outline-none text-text-main font-mono font-bold shadow-inner">
                                    </div>
                                    <button onclick="openCalc()" class="bg-gray-100 px-4 rounded-xl text-gray-500 hover:bg-gray-200 border-0 shadow-sm"><i class="fa-solid fa-calculator"></i></button>
                                </div>
                                <div id="approxVal" class="text-[10px] text-gray-400 text-right mt-1 h-4 font-bold"></div>
                            </div>

                            <div class="select-wrapper"><select id="itemSplit" onchange="toggleUnevenSplit()" class="w-full bg-snow-blue border-0 rounded-xl p-3 text-sm outline-none appearance-none font-bold text-text-main">
                                <option value="Âπ≥ÂùáÂàÜÊî§" selected>Âπ≥ÂùáÂàÜÊî§</option>
                                ${staticData.splitOptions.map(s => s!=='Âπ≥ÂùáÂàÜÊî§'?`<option>${s}</option>`:'').join('')}
                            </select></div>
                            
                            <div id="unevenSplitInputs" class="hidden grid grid-cols-2 gap-3 bg-gray-50 p-2 rounded-xl border border-dashed border-gray-300">
                                <div><label class="text-[10px] text-gray-400 block mb-1 font-bold">Andy</label><input type="number" id="splitAndy" oninput="autoCalcSplit('andy')" class="w-full bg-white border border-gray-200 rounded-lg p-2 text-sm text-center shadow-inner"></div>
                                <div><label class="text-[10px] text-gray-400 block mb-1 font-bold">Lynn</label><input type="number" id="splitLynn" oninput="autoCalcSplit('lynn')" class="w-full bg-white border border-gray-200 rounded-lg p-2 text-sm text-center shadow-inner"></div>
                            </div>

                            <div class="select-wrapper"><select id="itemCat" class="w-full bg-snow-blue border-0 rounded-xl p-3 text-sm outline-none appearance-none font-bold text-text-main">
                                <option value="È£≤È£ü" selected>È£≤È£ü</option>
                                ${staticData.categories.map(c => c!=='È£≤È£ü'?`<option>${c}</option>`:'').join('')}
                            </select></div>
                            
                            <input type="text" id="itemName" placeholder="ÂìÅÈ†ÖÂêçÁ®±" class="w-full bg-snow-blue border-0 rounded-xl p-3 text-sm outline-none font-bold text-text-main">

                            ${!GOOGLE_SCRIPT_URL ? `<label class="flex items-center justify-center gap-2 text-sm text-gray-500 bg-gray-50 px-3 py-3 rounded-xl cursor-pointer border border-dashed border-gray-300 hover:bg-white hover:border-festive-green transition w-full font-bold"><i class="fa-solid fa-receipt"></i><span id="photoLabel">‰∏äÂÇ≥Êî∂Êìö (ÈÅ∏Â°´)</span><input type="file" id="itemPhoto" accept="image/*" class="hidden" onchange="document.getElementById('photoLabel').innerText = 'Â∑≤ÈÅ∏Êìá'"></label>` : ''}

                            <button onclick="addExpense()" id="btnSubmit" class="w-full bg-festive-red text-white font-bold py-3.5 rounded-xl shadow-lg hover:opacity-90 transition mt-2 tracking-wide font-title active:scale-95 transform">
                                ${state.editingId ? 'Êõ¥Êñ∞Á¥ÄÈåÑ' : '‚ú® Âä†ÂÖ•Ë®òÂ∏≥'}
                            </button>
                        </div>
                    </div>

                    <div class="flex border-b border-gray-200 mb-4 overflow-x-auto no-scrollbar">
                         ${state.itinerary.map((d, i) => `
                            <button onclick="state.walletDay=${i};renderWallet()" class="flex-1 py-2 text-xs font-bold whitespace-nowrap transition-colors font-title ${i === state.walletDay ? 'text-festive-green border-b-2 border-festive-green' : 'text-gray-400 hover:text-gray-500'}">${d.shortTitle}</button>
                        `).join('')}
                    </div>

                    <div class="space-y-3">
            `;

            const dailyExpenses = state.expenses.filter(e => parseInt(e.day) === state.walletDay);
            
            if (dailyExpenses.length === 0) html += `<div class="text-center text-gray-300 py-10 text-sm italic font-bold">‚ùÑÔ∏è ÈÄôË£°ÈÇÑÊ≤íÊúâÈõ™Âú∞Ë∂≥Ë∑°...</div>`;
            else {
                [...dailyExpenses].reverse().forEach((item) => {
                    const payerTextClass = item.payer === 'Andy' ? 'text-blue-500 bg-blue-50' : item.payer === 'Lynn' ? 'text-pink-500 bg-pink-50' : 'text-gray-500 bg-gray-100';
                    const catTextClass = { 'È£≤È£ü':'text-orange-500 bg-orange-50', '‰∫§ÈÄö':'text-blue-500 bg-blue-50', 'Ë≥ºÁâ©ÈÄõË°ó':'text-pink-500 bg-pink-50', '‰ΩèÂÆø':'text-purple-500 bg-purple-50', 'ÊôØÈªû':'text-emerald-500 bg-emerald-50', 'ÈñÄÁ•®':'text-amber-500 bg-amber-50' }[item.cat] || 'text-gray-500 bg-gray-50';

                    let displayVal = `${item.currency === 'KRW' ? '‚Ç©' : 'NT$'}${formatMoney(item.amount)}`;
                    let approxVal = '';
                    if (item.currency === 'KRW') {
                        let approx = Math.round(item.amount * state.exchangeRate);
                        approxVal = ` <span class="text-[10px] text-gray-400 block text-right mt-0.5">‚âà NT$${formatMoney(approx)}</span>`;
                    }

                    html += `
                        <div class="card-panel p-4 flex items-center gap-3 relative group transition hover:shadow-md border-l-4 ${item.payer==='Andy'?'border-l-blue-300':item.payer==='Lynn'?'border-l-pink-300':'border-l-gray-300'}">
                            <div class="flex-1 min-w-0">
                                <div class="font-bold text-text-main truncate text-base mb-1">${item.name}</div>
                                <div class="flex flex-wrap gap-1.5">
                                    <span class="text-[10px] px-2 py-0.5 rounded-lg font-bold ${payerTextClass}">${item.payer}</span>
                                    <span class="text-[10px] px-2 py-0.5 rounded-lg font-bold ${catTextClass}">${item.cat}</span>
                                    <span class="text-[10px] bg-gray-50 text-gray-400 px-2 py-0.5 rounded-lg font-bold">${item.method}</span>
                                    ${item.image ? '<span class="text-[10px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded-lg cursor-pointer hover:bg-gray-200" onclick="showImage(\''+item.image+'\')"><i class="fa-solid fa-image"></i></span>' : ''}
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-festive-red font-mono text-base leading-tight">${displayVal}</div>
                                ${approxVal}
                                <div class="flex gap-3 justify-end mt-2 opacity-100 sm:opacity-0 group-hover:opacity-100 transition">
                                    <button onclick="editExpense('${item.id}')" class="text-gray-300 hover:text-gray-500"><i class="fa-solid fa-pen"></i></button>
                                    <button onclick="deleteExpense('${item.id}')" class="text-gray-300 hover:text-danger"><i class="fa-solid fa-trash-can"></i></button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            html += `</div></div>`;
            html += `<div id="imageModal" class="fixed inset-0 bg-black/90 z-[70] hidden flex items-center justify-center p-4 backdrop-blur-sm" onclick="this.classList.add('hidden')"><img id="modalImg" src="" class="max-w-full max-h-full rounded shadow-2xl"></div>`;
            app.innerHTML = html;
        }

        // --- Other Renderers (Map, Lists, Info) ---
        function renderMap() { app.innerHTML = `<div class="fade-in h-[85vh] flex flex-col"><div class="card-panel p-3 mb-3 text-center text-xs text-gray-500 flex items-center justify-center gap-2"><i class="fa-solid fa-hand-pointer text-festive-green"></i> ÈõôÊåáÁ∏ÆÊîæ<a href="https://map.naver.com/" target="_blank" class="text-festive-green font-bold underline ml-2">ÈñãÂïü Naver</a></div><div class="map-wrapper card-panel rounded-2xl relative overflow-hidden" id="mapContainer"><img id="mapImg" src="https://upload.wikimedia.org/wikipedia/commons/b/b6/Seoul_subway_linemap_en_ko.png" class="absolute top-0 left-0 min-w-[150%] h-auto origin-top-left touch-none" alt="Map"></div></div>`; setTimeout(initMapZoom, 100); }
        function initMapZoom() { const c=document.getElementById('mapContainer'), i=document.getElementById('mapImg'); if(c&&i){i.style.position='absolute';c.style.overflow='auto';} }
        function renderLists() { let html=`<div class="fade-in space-y-6 pb-20">`; const groups={}; state.checklist.forEach(i=>{if(!groups[i.category])groups[i.category]=[];groups[i.category].push(i)}); for(let cat in groups){ html+=`<div class="card-panel p-5"><h2 class="text-sm font-bold text-festive-green mb-4 border-b border-gray-100 pb-2">${cat}</h2><div class="grid grid-cols-2 gap-y-3 gap-x-4">`; groups[cat].forEach(item=>{ const idx=state.checklist.findIndex(x=>x.text===item.text); html+=`<label class="flex items-center cursor-pointer select-none group"><input type="checkbox" class="hidden custom-checkbox" ${item.checked?'checked':''} onchange="toggleCheck(${idx})"><div class="w-4 h-4 border border-gray-300 rounded mr-2 flex items-center justify-center transition-colors bg-white group-hover:border-festive-green"></div><span class="text-sm ${item.checked?'text-gray-300 line-through':'text-text-main'} group-hover:text-festive-green transition-colors font-bold">${item.text}</span></label>`; }); html+=`</div></div>`; } app.innerHTML=html+`</div>`; }
        function renderInfo() { 
            app.innerHTML = `<div class="fade-in grid gap-4">
                <a href="https://n.weather.naver.com/" target="_blank" class="card-panel p-6 flex items-center justify-between hover:shadow-md transition"><div><h3 class="font-bold text-text-main text-lg font-title">È¶ñÁàæÂ§©Ê∞£</h3><p class="text-xs text-gray-400 mt-1 font-bold">Naver Weather</p></div><i class="fa-solid fa-cloud-sun text-4xl text-gray-300"></i></a>
                <div class="card-panel bg-red-50 p-6 border border-red-100"><h3 class="font-bold text-danger text-lg mb-3 font-title"><i class="fa-solid fa-phone mr-2"></i>Á∑äÊÄ•ËÅØÁµ°</h3><div class="space-y-2 text-sm text-gray-600"><div class="flex justify-between border-b border-red-100/50 pb-2"><span>Ë≠¶ÂØü</span><span class="font-mono font-bold text-danger text-lg">112</span></div><div class="flex justify-between border-b border-red-100/50 pb-2"><span>ÊïëË≠∑Ëªä</span><span class="font-mono font-bold text-danger text-lg">119</span></div><div class="pt-1"><span class="block font-bold text-gray-700 mb-1">ËßÄÂÖâË´ÆË©¢</span><span class="block font-mono text-gray-500">1330</span></div></div></div>
                <div class="card-panel p-6 text-center">
                    <h3 class="font-bold text-text-main text-lg mb-3 font-title">Ë≥áÊñôÂÇô‰ªΩËàáÈÇÑÂéü</h3>
                    <p class="text-xs text-gray-400 mb-4">ÁÑ°Ê≥ï‰ΩøÁî®Èõ≤Á´ØÂêåÊ≠•ÊôÇÔºåÂèØ‰ΩøÁî®‰ª£Á¢ºÊâãÂãïÂÇ≥Ëº∏Ë≥áÊñô„ÄÇ</p>
                    <button onclick="document.getElementById('syncModal').classList.remove('hidden')" class="bg-gray-100 text-gray-600 px-4 py-2 rounded-xl text-sm font-bold shadow-sm hover:bg-gray-200 transition">ÈñãÂïüÊâãÂãïÂêåÊ≠•</button>
                </div>
            </div>`; 
        }

        function router(target) { state.activeTab = target; document.querySelectorAll('.nav-btn').forEach(btn => { btn.classList.toggle('text-festive-red', btn.dataset.target === target); btn.classList.toggle('text-gray-400', btn.dataset.target !== target); }); if (target === 'plan') renderPlan(); else if (target === 'map') renderMap(); else if (target === 'wallet') renderWallet(); else if (target === 'lists') renderLists(); else if (target === 'info') renderInfo(); window.scrollTo(0,0); }

        function setCurrency(c) { 
            state.expenseCurrency = c; 
            updateApprox();
            document.getElementById('currSymbol').innerText = c === 'KRW' ? '‚Ç©' : '$';
        }
        function updateApprox() {
            const val = parseFloat(document.getElementById('itemAmount').value);
            const disp = document.getElementById('approxVal');
            if (state.expenseCurrency === 'KRW' && !isNaN(val)) {
                disp.innerText = `‚âà NT$${Math.round(val * state.exchangeRate).toLocaleString()}`;
            } else {
                disp.innerText = '';
            }
        }
        function toggleUnevenSplit() { const s = document.getElementById('itemSplit').value; document.getElementById('unevenSplitInputs').classList.toggle('hidden', s !== '‰∏çÂπ≥ÂùáÂàÜÊî§'); document.getElementById('unevenSplitInputs').classList.toggle('grid', s === '‰∏çÂπ≥ÂùáÂàÜÊî§'); }
        function autoCalcSplit(src) {
            const total = parseFloat(document.getElementById('itemAmount').value)||0;
            const aIn = document.getElementById('splitAndy'); const lIn = document.getElementById('splitLynn');
            if(src==='andy') lIn.value = total - (parseFloat(aIn.value)||0);
            else if(src==='lynn') aIn.value = total - (parseFloat(lIn.value)||0);
        }
        
        // --- FIXED SUBMIT EXPENSE ---
        function addExpense() {
            const btn = document.getElementById('btnSubmit');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ËôïÁêÜ‰∏≠...';
            btn.disabled = true;

            setTimeout(() => { 
                try {
                    const name=document.getElementById('itemName').value, amount=document.getElementById('itemAmount').value, payer=document.getElementById('itemPayer').value, method=document.getElementById('itemMethod').value, cat=document.getElementById('itemCat').value, split=document.getElementById('itemSplit').value;
                    const fileInput = document.getElementById('itemPhoto');
                    
                    let day = state.walletDay; 
                    document.getElementsByName('expenseDay').forEach(r => { if(r.checked) day = parseInt(r.value); });
                    const val = safeCalculate(amount);
                    
                    if(!name || val===null || !payer || !method) { 
                        let missing = [];
                        if(!name) missing.push("ÂìÅÈ†Ö");
                        if(!val) missing.push("ÈáëÈ°ç");
                        if(!payer) missing.push("ÊîØ‰ªòËÄÖ");
                        if(!method) missing.push("ÊîØ‰ªòÊñπÂºè");
                        alert('Ë´ãÂ°´ÂØ´Ôºö' + missing.join('„ÄÅ')); 
                        throw new Error('Validation failed');
                    }
                    
                    let cSplit = null;
                    if(split==='‰∏çÂπ≥ÂùáÂàÜÊî§') cSplit = { andy: parseFloat(document.getElementById('splitAndy').value)||0, lynn: parseFloat(document.getElementById('splitLynn').value)||0 };

                    const item = { id: state.editingId||generateId(), day, cat, split, name, amount: val, payer, method, currency: state.expenseCurrency, customSplit: cSplit, date: new Date().toLocaleDateString() };
                    
                    const saveLocal = (imgData) => {
                        if(imgData) item.image = imgData;
                        
                        if(state.editingId) { const idx = state.expenses.findIndex(e=>e.id===state.editingId); if(idx!==-1) state.expenses[idx]=item; state.editingId=null; }
                        else state.expenses.push(item);
                        
                        saveToLS(); 
                        renderWallet();
                        
                        document.getElementById('itemName').value = '';
                        document.getElementById('itemAmount').value = '';
                        document.getElementById('photoLabel').innerText = '‰∏äÂÇ≥Êî∂Êìö (ÈÅ∏Â°´)';
                        
                        // Reset defaults
                        document.getElementById('itemPayer').value = 'ÂÖ¨Ë≤ª';
                        document.getElementById('itemMethod').value = 'ÁèæÈáë';
                        document.getElementById('itemCat').value = 'È£≤È£ü';
                        document.getElementById('itemSplit').value = 'Âπ≥ÂùáÂàÜÊî§';
                        toggleUnevenSplit();

                        if(GOOGLE_SCRIPT_URL) syncToCloud(state.editingId ? 'edit' : 'add', item);
                    };

                    if (fileInput && fileInput.files && fileInput.files[0]) {
                        compressImage(fileInput.files[0], (base64) => { saveLocal(base64); });
                    } else {
                        saveLocal(null);
                    }
                } catch(e) {
                    console.error(e);
                    btn.innerHTML = state.editingId ? 'Êõ¥Êñ∞Á¥ÄÈåÑ' : '‚ú® Âä†ÂÖ•Ë®òÂ∏≥';
                    btn.disabled = false;
                }
            }, 100);
        }

        function editExpense(id) {
            const ex = state.expenses.find(e => e.id === id); if(!ex) return;
            state.editingId = id; state.walletDay = ex.day; state.expenseCurrency = ex.currency || 'KRW';
            renderWallet();
            setTimeout(() => {
                document.getElementById('itemPayer').value = ex.payer; document.getElementById('itemMethod').value = ex.method; document.getElementById('itemAmount').value = ex.amount;
                document.getElementById('itemSplit').value = ex.split; document.getElementById('itemCat').value = ex.cat; document.getElementById('itemName').value = ex.name;
                document.getElementById('itemCurrency').value = state.expenseCurrency; 
                toggleUnevenSplit();
                if(ex.customSplit) { document.getElementById('splitAndy').value = ex.customSplit.andy; document.getElementById('splitLynn').value = ex.customSplit.lynn; }
                updateApprox();
            }, 50);
        }
        function cancelEdit() { state.editingId = null; renderWallet(); }
        function deleteExpense(id) { if(confirm('Âà™Èô§?')) { if(GOOGLE_SCRIPT_URL) syncToCloud('delete', {id: id}); state.expenses=state.expenses.filter(e=>e.id!==id); saveToLS(); renderWallet(); } }
        function showImage(src) { document.getElementById('modalImg').src = src; document.getElementById('imageModal').classList.remove('hidden'); }
        function toggleCheck(i) { state.checklist[i].checked = !state.checklist[i].checked; saveToLS(); renderLists(); }

        let calcVal = '0';
        function openCalc() { document.getElementById('calcModal').classList.remove('hidden'); calcVal='0'; document.getElementById('calcDisplay').innerText='0'; }
        function closeCalc() { document.getElementById('calcModal').classList.add('hidden'); }
        function calcAppend(c) { if(calcVal==='0' && !['.','/','*','-','+'].includes(c)) calcVal=c; else calcVal+=c; document.getElementById('calcDisplay').innerText=calcVal; }
        function calcClear() { calcVal='0'; document.getElementById('calcDisplay').innerText='0'; }
        function calcConfirm() { const r=safeCalculate(calcVal); if(r!==null) { document.getElementById('itemAmount').value=r; autoCalcSplit('total'); updateApprox(); closeCalc(); } }

        window.submitExpense = addExpense;
        router('plan');
    </script>
</body>
</html>